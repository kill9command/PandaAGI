# Gateway and Orchestrator configuration
ORCH_URL=http://127.0.0.1:8090
SOLVER_URL=http://127.0.0.1:8000/v1/chat/completions
THINK_URL=http://127.0.0.1:8000/v1/chat/completions

# vLLM (serve_llm.sh) defaults
SOLVER_MODEL_ID=qwen3-coder
THINK_MODEL_ID=qwen3-coder
SOLVER_API_KEY=qwen-local
THINK_API_KEY=qwen-local

# vLLM model directory override (optional)
# MODEL_DIR=/absolute/path/to/models/qwen3-coder-30b-awq4

# Optional: set to enforce API-key auth at Gateway (external callers)
GATEWAY_API_KEY=changeme-dev-key

# Performance Optimization Settings (added: 2025-11-12)
# Parallel execution concurrency limits
PARALLEL_FETCH_LIMIT=3           # Max concurrent web fetches (research verification)
PARALLEL_SEARCH_LIMIT=3          # Max concurrent search queries (research)

# Semantic cache validation thresholds
CACHE_SEMANTIC_THRESHOLD=0.85    # Embedding similarity threshold (0.0-1.0)
CACHE_KEYWORD_THRESHOLD=0.3      # Keyword overlap threshold (0.0-1.0)

# Circuit breaker settings
SERPAPI_CIRCUIT_BREAKER_THRESHOLD=2  # Consecutive failures before stopping

# Crawler session persistence (added: 2025-11-15)
# How long browser sessions (cookies, localStorage) persist before expiring
CRAWLER_SESSION_TTL_HOURS=87600      # Default: 10 years - permanent cookie/session storage
                                      # Set to 24 for daily expiry, 8760 for 1 year, or any custom value

# Playwright CDP Remote Debugging (added: 2025-11-17)
# Enables Chrome DevTools Protocol for browser connection
PLAYWRIGHT_CDP_PORT=9223             # CDP remote debugging port (default: 9223)
                                      # Allows user's browser to connect to Playwright browser
                                      # Used for automatic cookie persistence during interventions

# Playwright Headless Mode (added: 2025-11-19)
# Controls browser visibility for better stealth AND manual CAPTCHA solving
PLAYWRIGHT_HEADLESS=false             # false=visible (best for CAPTCHA solving + anti-detection)
                                      # new=Chrome 112+ stealth headless
                                      # true=old headless (easily detected, CAPTCHAs unsolvable)
                                      #
                                      # When false: Browser window appears, you can solve CAPTCHAs manually
                                      # System auto-waits up to 90s for you to solve, then continues
                                      # See CAPTCHA_SOLVING_GUIDE.md for details

# Browser Engine Selection (added: 2025-12-01)
# Which browser engine to use for headless automation
BROWSER_ENGINE=firefox               # firefox (default, stable) or chromium (faster but crashes on some sites)
                                      # firefox: More stable on heavy JS sites (eBay, etc.), better memory management
                                      # chromium: Faster startup, better stealth tooling support
                                      # Note: local_view mode always uses YOUR browser (Chrome/Firefox/etc.)

# Local Browser Control Mode (added: 2025-11-22)
# DEFAULT MODE: local_view - Connects to YOUR browser for CAPTCHA solving
# Allows connecting Playwright to a browser running on your laptop/phone via CDP
# This enables watching the automation in real-time and solving CAPTCHAs remotely
BROWSER_DEFAULT_MODE=local_view      # local_view (default, CAPTCHA support) or headless (deprecated)
                                      # local_view requires:
                                      #   1. Launch Chrome: chrome --remote-debugging-port=9222
                                      #   2. Call API: POST /api/browser/connect
                                      # See LOCAL_BROWSER_CONTROL.md for complete setup instructions
                                      #
                                      # headless mode is deprecated - CAPTCHAs timeout after 90s

# Unified 7-Phase Architecture
UNIFIED_FLOW_ENABLED=true             # Enable unified flow (REQUIRED - only supported flow)
                                      # 7 phases: Context Gatherer → Reflection → Planner → Coordinator → Synthesis → Validation → Save
                                      # Note: V4Flow and V5Flow are deprecated and removed

# Context Gatherer uses 2-phase implementation (ContextGatherer2Phase)
# - RETRIEVAL: Identify relevant turns and decide what to read
# - SYNTHESIS: Extract and compile into context.md §1
# Benefits: 22% token reduction, 50% fewer LLM calls vs deprecated 4-phase

# Recipe-Based Research Integration (added: 2025-12-08)
RECIPE_RESEARCH_ENABLED=false         # Enable recipe-based research orchestration (default: false)
                                      # When enabled, research uses:
                                      # - Research Planner LLM Role (decides Phase 1/Phase 2/Both)
                                      # - Phase 1 Intelligence Cache (global, shared across sessions)
                                      # - Phase 2 Results Search (vendor extraction)
                                      # - Document output (.md files: research_plan.md, phase1_intelligence.md, phase2_results.md)
                                      # Set to true to enable the new recipe-based research system

# Vision Automation Settings (added: 2025-11-20)
RESEARCH_USE_VISION=false             # Enable vision-in-the-loop for web research (default: false)
                                      # false = legacy scripted navigation (SerpAPI + human_web_navigator)
                                      # true = vision-guided browser automation (web.* tools + LLM planning)
                                      # Vision mode: more flexible, handles dynamic sites, but uses more tokens
                                      # Legacy mode: faster, cheaper, but limited to known patterns
# Browser Control Feature (added: 2025-11-22)
# Enables remote browser viewing/control via Chrome DevTools Protocol (CDP)
ENABLE_BROWSER_CONTROL=true          # Feature flag (default: true)
                                      # Enable browser viewing from your phone/laptop during interventions
BROWSER_SESSION_TIMEOUT_MIN=30       # Idle session timeout (default: 30 minutes)
                                      # How long browser sessions remain viewable after last activity
BROWSER_MAX_CONCURRENT_SESSIONS=50   # Maximum concurrent viewable sessions (default: 50)
                                      # Limit to prevent memory exhaustion
# For production deployments:
# BROWSER_CONTROL_SECRET_KEY=<generate-random-key>  # HMAC token signing (future)
# SESSION_TOKEN_TTL_HOURS=24                         # Browser control link expiry (future)

# Multi-Query Research System (added: 2025-11-22)
# LLM-driven query optimization with iterative search and result evaluation
ENABLE_MULTI_QUERY=true                # Enable multi-query research (default: true)
                                        # true = LLM generates multiple optimized queries, evaluates results
                                        # false = legacy single-query approach
MAX_SEARCH_QUERIES=3                    # Maximum search queries per research session (default: 3)
                                        # System stops early if quality threshold met
QUERY_PLANNER_BUDGET=500                # Token budget for LLM query planning (default: 500)
                                        # Used by query_planner.py to generate search strategy
MIN_QUALITY_THRESHOLD=0.7               # Minimum quality score to be satisfied (0.0-1.0, default: 0.7)
                                        # Stops searching when results meet this threshold
                                        # Lower = faster but potentially lower quality
                                        # Higher = more thorough but uses more API calls

# Context Manager Architecture (added: 2025-11-26)
# Two-phase context management: Turn Summarizer + Document Compressor

# Turn Summarizer - LLM-based turn summarization at end of each turn
ENABLE_LLM_TURN_SUMMARIZER=true         # Enable LLM-based turn summarization (default: true)
                                        # Creates semantic summary of each turn for next query context
                                        # Captures: key findings, preferences, satisfaction, topic
TURN_SUMMARIZER_TIMEOUT=20.0            # Timeout for turn summarizer LLM call (seconds)
                                        # Set higher if vLLM is slow to respond

# Document Compressor - Smart compression for doc packs
ENABLE_SMART_COMPRESSION=false          # Enable smart document compression in DocPackBuilder (default: false)
                                        # true = use key sentence extraction (preserves semantics)
                                        # false = simple truncation (faster, less intelligent)
                                        # Affects all LLM calls that use DocPackBuilder
COMPRESSOR_LLM_THRESHOLD=500            # Min tokens to use LLM compression in async mode (default: 500)
                                        # Documents smaller than this use simple extraction

# Unified Site Calibrator (added: 2025-12-08)
# Learns URL parameter encodings and HTML patterns automatically for any website
USE_UNIFIED_CALIBRATOR=false            # Enable unified calibrator (default: false)
                                        # true = learn URL patterns by clicking filters & observing changes
                                        #        Uses learned patterns for price filter detection
                                        # false = use hard-coded patterns for known retailers
                                        # Profiles stored in site_profiles/*.json
CALIBRATOR_DEBUG=false                  # Enable verbose calibration logging (default: false)
                                        # Shows LLM prompts, URL diffs, element detection
CALIBRATOR_MAX_AGE_DAYS=7               # Re-learn sites older than this (default: 7 days)

# Mode Enforcement & Repository Permissions (added: 2025-12-17)
# Controls what operations are allowed in chat vs code mode, and which repositories
SAVED_REPO=/home/henry/pythonprojects/stockanalysis
                                        # Primary repository for code operations
                                        # Operations in this path auto-allowed in code mode
                                        # Operations outside require user approval
                                        # If not set, all paths are allowed (backwards compatible)
ENFORCE_MODE_GATES=1                    # Enable mode gate enforcement (default: 1)
                                        # 1 = enforce chat/code mode restrictions
                                        # 0 = disable all permission checks (testing only)
EXTERNAL_REPO_TIMEOUT=180               # Timeout for external repo approval prompts (seconds)
                                        # How long to wait for user to approve/deny
                                        # Default: 180 seconds (3 minutes)
