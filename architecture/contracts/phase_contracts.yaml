# Phase I/O Contracts - Machine-readable spec for phases 0-8
#
# Each phase lists required inputs, outputs, and schemas.
# Used by contract tests to verify pipeline correctness.
#
# Updated: 2026-02-03
# Changes: Added resolved_query to Phase 0. Expanded Phase 2 output structure.
#          Added route_to/workflow to Phase 3. Added decisions to metrics schema.
#          Fixed Phase 7 decision values (APPROVE/REVISE/RETRY/FAIL).

version: "1.1"
description: "Per-phase I/O contracts for Panda pipeline"

schemas:
  plan_state:
    file: plan_state.json
    required_fields:
      - goals       # array of goal objects
      - last_updated_phase
    goal_fields:
      - id
      - description
      - status

  tool_results:
    file: toolresults.md
    format: markdown
    required_sections:
      - "Tool Results"

  response:
    file: response.md
    format: markdown
    min_length: 10

  metrics:
    file: metrics.json
    required_fields:
      - turn_number
      - timestamp
      - phases_completed
    optional_fields:
      - total_duration_ms
      - token_usage
      - quality_score
      - decisions        # array of {phase, decision_type, decision_value}

  artifact_manifest:
    file: artifact_manifest.json
    required_fields:
      - turn_id
      - artifacts
      - total_artifacts
      - created_at

phases:
  phase_0:
    name: "Query Analyzer"
    description: "Parse user query into structured analysis"
    role: REFLEX
    temperature: 0.4
    inputs:
      - user_query  # raw text from user
    outputs:
      context_doc:
        section: "§0 User Query"
        required_fields:
          - resolved_query  # disambiguated query text
          - user_purpose    # natural language statement of user's intent
          - mode            # chat/code
          - data_requirements    # {needs_current_prices, needs_product_urls, needs_live_data, freshness_required}
        optional_fields:
          - content_reference    # {title, content_type, site, source_turn}
          - reference_resolution # {status, original_references, resolved_to}

  phase_1:
    name: "Reflection"
    description: "Fast binary gate: can we answer this query?"
    role: REFLEX
    temperature: 0.4
    inputs:
      - context_doc   # with §0 populated
    outputs:
      context_doc:
        section: "§1 Reflection Decision"
        required_fields:
          - decision    # PROCEED/CLARIFY
          - reason
        optional_fields:
          - relevant_turns

  phase_2:
    name: "Context Gathering"
    description: "Gather context from memory, prior turns, and research cache"
    role: MIND
    temperature: 0.6
    inputs:
      - context_doc    # with §0, §1
    outputs:
      context_doc:
        section: "§2 Gathered Context"
        required_fields:
          - sources           # list of source references
        optional_fields:
          - session_preferences   # user preferences from memory
          - prior_turns           # relevant prior turn summaries
          - cached_research       # cached intelligence if available
          - visit_data            # cached visit record data
          - constraints           # extracted user constraints (budget, must_avoid, etc.)
          - context_assessment    # overall context quality score and gaps
    error_handling:
      hard_errors: HALT      # data integrity and infrastructure failures
      soft_results: PROCEED  # no relevant sources found (new topic)

  phase_3:
    name: "Planner"
    description: "Generate strategic plan with goals and routing decision"
    role: MIND
    temperature: 0.6
    inputs:
      - context_doc     # with §0, §1, §2
    outputs:
      context_doc:
        section: "§3 Task Plan"
        required_fields:
          - strategy      # natural language strategic approach
          - goals         # array of goal objects
          - route_to      # executor/synthesis/clarify
        optional_fields:
          - workflow       # selected workflow name (e.g., "intelligence_search", "product_research")
      files:
        - ticket.md        # task ticket
        - plan_state.json  # initialized with goals

  phase_4:
    name: "Executor"
    description: "Tactical tool execution commands"
    role: MIND
    temperature: 0.6
    inputs:
      - context_doc       # with §0-§3
      - plan_state.json
    outputs:
      context_doc:
        section: "§4 Tool Execution"
      files:
        - toolresults.md   # when tools are executed

  phase_5:
    name: "Coordinator"
    description: "Translate commands to tool calls (deterministic tool selection)"
    role: REFLEX
    temperature: 0.4
    inputs:
      - tool_command      # natural language command from executor
      - plan_state.json
    outputs:
      files:
        - toolresults.md   # tool execution results
      side_effects:
        - plan_state_updates

  phase_6:
    name: "Synthesis"
    description: "Synthesize response from all gathered context and results"
    role: VOICE
    temperature: 0.7
    inputs:
      - context_doc       # with §0-§4
      - toolresults.md    # if tools were executed
    outputs:
      context_doc:
        section: "§6 Synthesis"
      files:
        - response.md      # user-facing response
        - artifact_manifest.json  # if artifacts generated

  phase_7:
    name: "Validation"
    description: "Validate response quality and requirement adherence (checks against §0)"
    role: MIND
    temperature: 0.6
    inputs:
      - context_doc       # with §0-§6
      - response.md
      - plan_state.json
    outputs:
      context_doc:
        section: "§7 Validation"
        required_fields:
          - decision       # APPROVE/REVISE/RETRY/FAIL
          - checks         # dict of check results
        optional_fields:
          - confidence     # 0.0-1.0
          - issues         # list of identified issues
          - revision_hints # guidance for synthesis revision
      side_effects:
        - plan_state_update

  phase_8:
    name: "Save"
    description: "Persist turn data and update indexes"
    role: N/A
    temperature: N/A
    inputs:
      - context_doc       # complete
      - response.md
    outputs:
      files:
        - metadata.json    # turn metadata
        - metrics.json     # performance metrics
        - plan_state.json  # if plan state exists
      side_effects:
        - turn_index_update
        - memory_persistence
