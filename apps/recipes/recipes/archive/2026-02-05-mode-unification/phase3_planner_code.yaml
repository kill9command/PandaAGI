# Phase 3: Planner (Code Mode) Recipe
# Strategic decision-maker: WHAT needs to be done
# Architecture: architecture/main-system-patterns/phase3-planner.md

name: phase3_planner_code
category: pipeline
phase: 3
role: MIND
mode: code
temperature: 0.6

prompt_fragments:
  - "apps/prompts/pipeline/phase3_planner_code.md"

input_docs:
  - path: "context.md"
    sections: ["0", "2"]
    path_type: "turn"
    optional: false
    max_tokens: 2000
    description: "Sections 0 and 2: query + gathered context"
  - path: "context.md"
    sections: ["0", "2", "3", "4", "5", "6"]
    path_type: "turn"
    optional: true
    max_tokens: 3500
    description: "Full context on RETRY (includes validation feedback in section 6)"

output_doc:
  path: "context.md"
  section: "3"
  description: "ยง3 render is produced by orchestrator from STRATEGIC_PLAN JSON"

token_budget:
  total: 6500
  prompt: 2000
  input_docs: 2200
  output: 2000
  buffer: 300

llm_params:
  temperature: 0.6
  max_tokens: 2000

output_schema: STRATEGIC_PLAN

description: |
  Phase 3: Planner (Code Mode) - Strategic Decision-Maker

  Uses MIND role (temp=0.6) for reasoning and planning.
  Determines WHAT needs to be done for code operations.

  **Core Question:** "What are the goals and how should we approach them?"

  **Output (STRATEGIC_PLAN):**
  ```json
  {
    "_type": "STRATEGIC_PLAN",
    "route_to": "executor|synthesis|clarify|refresh_context",
    "goals": [
      {"id": "GOAL_1", "description": "Understand current implementation", "priority": "high"},
      {"id": "GOAL_2", "description": "Add error handling", "depends_on": "GOAL_1"},
      {"id": "GOAL_3", "description": "Verify changes work", "depends_on": "GOAL_2"}
    ],
    "approach": "Read current code, add try/except blocks, run tests",
    "success_criteria": "Error handling added and tests pass",
    "reason": "Need to read and modify code files",
    "refresh_context_request": ["missing_context_item"]
  }
  ```

  **Key Principle:** Strategic, not tactical. The Executor handles specific operations.
