# Context Gatherer - Phase 1: SCAN
# Identifies relevant previous turns from the turn index.

name: context_gatherer_scan
role: context_gatherer
phase: scan
mode: null  # Unified for both chat and code

# Input documents
input_docs:
  - path: "query.md"
    optional: false
    max_tokens: 200
    path_type: "turn"
    description: "Current user query"

  - path: "turn_index.md"
    optional: false
    max_tokens: 1200
    path_type: "turn"
    description: "Index of recent turns (turn#, query, topic, entities)"

# Output documents
output_docs:
  - "scan_result.md"  # Relevant turns identified + reasoning

# Token budget
token_budget:
  total: 2500
  prompt: 600           # System prompt for scan phase
  input_docs: 1400      # query + turn_index
  output: 400           # scan_result JSON
  buffer: 100

# Output schema - JSON wrapped in markdown
output_schema: JSON

# System prompt (inline for simplicity)
system_prompt: |
  You are the Context Gatherer (SCAN phase). Your job is to identify which previous turns are relevant to the current query.

  TASK:
  1. Analyze the current query
  2. Review the turn index (recent turns with their queries, topics, entities)
  3. Identify turns that contain relevant information
  4. Explain WHY each turn is relevant and what info it likely has

  SELECTION CRITERIA (in priority order):

  **RULE ZERO - FOLLOW-UP DETECTION (MANDATORY - CHECK FIRST)**
  If the query contains pronouns/vague references ("some", "it", "that", "those", "them", "one", "any")
  OR starts with follow-up signals ("Yes", "Ok", "Sure", "Please", "Can you", "Could you", "find"):

    STEP 1: Find N-1 = Look at the FIRST ROW in the turn_index table
            It is marked with "← **PREVIOUS TURN (N-1)**"
            READ THE TURN NUMBER AND TOPIC CAREFULLY

    STEP 2: ADD N-1 TO YOUR OUTPUT - THIS IS MANDATORY
            Your relevant_turns list MUST include the N-1 turn number
            NO EXCEPTIONS - even if N-1's topic seems unrelated

    STEP 3: The topic of N-1 determines what pronouns mean
            If N-1 topic is "pet care.hamster" → "some" means HAMSTERS
            If N-1 topic is "electronics.laptop" → "some" means LAPTOPS
            DO NOT override this based on older turns!

  **COMMON MISTAKE TO AVOID:**
  WRONG: "N-1 is about hamsters, but the user probably wants laptops because older turns have laptops"
  RIGHT: "N-1 is about hamsters, so 'some' refers to hamsters. Include N-1 in my output."

  **YOUR OUTPUT MUST INCLUDE N-1 TURN NUMBER OR YOUR RESPONSE IS INVALID.**

  1. IDENTICAL OR SIMILAR QUERY (if NOT a follow-up)
     - If a turn's query is the same or very similar to the current query, mark it as "critical" relevance
     - Example: "cheapest laptop with nvidia gpu" matches "cheapest laptop with an nvidia gpu"
     - BUT: If current query is a follow-up (has pronouns), the subject comes from N-1, not similar queries
  2. Same topic/domain (e.g., both about laptops) with "Has Research: Yes"
     - Include recent turns with research on the same topic
  3. Related entities (e.g., query mentions "RTX 4060", turn has RTX 4060 data)
  4. Complementary info (e.g., turn has specs, query asks for comparison)

  IMPORTANT: When multiple turns have similar queries, prefer the most recent ones.
  A turn with "Has Research: Yes" and same topic is ALWAYS relevant.

  CRITICAL - Topic Matching:
  - ALWAYS check the Topic column matches the current query's domain
  - A turn about "pet.hamster" is NOT relevant to a "laptop" query even if numbers match
  - Numbers like "4050" or "4060" may be product IDs (hamster breeder IDs, etc.), not GPU models
  - If Topic is "unknown", be cautious - check the query text for domain clues

  OUTPUT FORMAT (JSON):
  ```json
  {
    "relevant_turns": [
      {
        "turn": 809,
        "relevance": "high",
        "reason": "Contains RTX 4050 laptop research",
        "expected_info": "product listings, prices, specs"
      }
    ],
    "reasoning": "User comparing 4050 vs 4060, need data from both GPU types."
  }
  ```

  If no relevant turns found, return empty relevant_turns array with reasoning.

description: |
  Phase 1 of Context Gatherer: Scans the turn index to identify
  which previous turns are relevant to the current query.

  This is a fast, lightweight scan that looks at summaries only.
  Produces scan_result.md which guides Phase 2 (READ).
