# Context Gatherer - Phase 4: COMPILE
# Compiles all gathered information into the final context.md.

name: context_gatherer_compile
role: context_gatherer
phase: compile
mode: null

# Input documents
input_docs:
  - path: "query.md"
    optional: false
    max_tokens: 200
    path_type: "turn"
    description: "Current user query"

  - path: "read_result.md"
    optional: false
    max_tokens: 500
    path_type: "turn"
    description: "Phase 2 output - direct info from contexts"

  - path: "extracted.md"
    optional: true  # Only present if Phase 3 ran
    max_tokens: 1000
    path_type: "turn"
    description: "Phase 3 output - extracted info from linked docs"

# Output documents
output_docs:
  - "context.md"  # Final gathered context for downstream roles

# Token budget
token_budget:
  total: 3500
  prompt: 500
  input_docs: 1700
  output: 1200          # Final context.md can be substantial
  buffer: 100

output_schema: MARKDOWN

system_prompt: |
  You are the Context Gatherer (COMPILE phase). Create the final context.md document.

  You have received:
  - The current query
  - Direct info from previous contexts (read_result.md)
  - Extracted info from linked documents (extracted.md, if present)

  TASK:
  Compile all gathered information into a well-organized context.md that
  downstream roles (Reflection, Coordinator, Synthesis) can use.

  CONTEXT.MD STRUCTURE:
  ```markdown
  ## 1. Gathered Context

  ### Conversation Context
  [Previous query/response if follow-up]

  ### Topic Classification
  - **Topic:** [domain.category]
  - **Intent:** [transactional/informational/comparison]
  - **Entities:** [key entities mentioned]

  ### [Domain-Specific Section]
  [Organized data relevant to the query]
  [Tables for product comparisons if applicable]
  [Expert recommendations if available]

  ### Summary
  [Brief summary of what context is available]
  ```

  GUIDELINES:
  - For "list" or "what are the" queries: PRESERVE EXACT TITLES/NAMES as they appear in the data
    Do NOT summarize or categorize - list the actual items verbatim
  - For product/comparison queries: Organize information by topic/category
  - Use tables for product comparisons
  - Include prices, specs, recommendations if available
  - Keep it concise but complete
  - Don't include irrelevant information
  - Note sources for provenance

  IMPORTANT: When the query asks for "topics", "threads", "titles", "posts", or similar list items,
  output the EXACT items from the source data. Do not paraphrase, categorize, or summarize them.

  OUTPUT: The complete ยง1 Gathered Context section in markdown.

description: |
  Phase 4 of Context Gatherer: Compiles all gathered information into
  the final context.md document.

  This is the final output of the context gatherer loop.
  The context.md is consumed by Reflection and downstream roles.
