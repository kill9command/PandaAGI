# Schema Builder Recipe
# Generates extraction schemas for structured data extraction from web pages
#
# Used to build site-specific extraction patterns before attempting
# product extraction. Proactive schema generation saves failed attempts.

name: tools_schema_builder
category: tools
role: schema_builder
model_layer: MIND  # Reasoning/analysis tasks use MIND (temp 0.5)

# Prompt fragments (loaded in order)
prompt_fragments:
  - "apps/prompts/tools/schema_builder.md"

# Input documents
input_docs:
  - path: "site_intent"
    path_type: "runtime"
    optional: false
    max_tokens: 100
    description: "Purpose of extraction (e.g., 'Extract product listings from search results')"

  - path: "page_url"
    path_type: "runtime"
    optional: false
    max_tokens: 200
    description: "URL of the page being analyzed"

  - path: "page_context"
    path_type: "runtime"
    optional: true
    max_tokens: 200
    description: "Page title, URL parameters, etc."

  - path: "repeated_elements"
    path_type: "temp"
    optional: false
    max_tokens: 500
    description: "List of CSS classes/selectors with occurrence counts"

  - path: "sample_html"
    path_type: "temp"
    optional: false
    max_tokens: 2000
    description: "HTML snippet of one product card or repeated item"

# Output document
output_doc:
  path: "extraction_schema.json"
  path_type: "temp"

# Token budget
token_budget:
  total: 5000
  prompt: 1300      # schema_builder.md prompt (includes examples)
  input_docs: 3000  # page context + repeated elements + sample HTML
  output: 600       # JSON schema
  buffer: 100

# Trimming strategy
trimming_strategy:
  method: intelligent_truncate
  priority:
    - keep: site_intent         # Always keep intent
    - keep: page_url            # Always keep URL
    - keep: repeated_elements   # Need element counts
    - truncate: sample_html     # Truncate HTML if too long

# Output schema
output_schema:
  type: object
  required:
    - item_selector
    - fields
    - confidence
  properties:
    item_selector:
      type: string
      description: "CSS selector for repeated items (product cards, etc.)"
    fields:
      type: object
      additionalProperties:
        type: object
        required:
          - selector
          - attribute
        properties:
          selector:
            type: string
          attribute:
            type: string
          transform:
            type: string
            enum: ["price", "trim", "lowercase", "url_decode", "strip_html"]
          required:
            type: boolean
          multiple:
            type: boolean
    url_patterns:
      type: object
      properties:
        search_param:
          type: string
        page_param:
          type: string
        sort_param:
          type: string
        price_min_param:
          type: string
        price_max_param:
          type: string
    pagination:
      type: object
      properties:
        next_selector:
          type: string
        total_pages_selector:
          type: string
        items_per_page:
          type: integer
    confidence:
      type: number
      minimum: 0
      maximum: 1
    notes:
      type: string

# Quality gates
quality_gates:
  schema_validation: true
  confidence_threshold: 0.5
  max_retries: 1

# Low confidence handling
low_confidence_action: fallback_to_vision

# Description
description: |
  Schema Builder analyzes page structure to create reusable extraction schemas.

  **Schema Building Rules:**
  - Selectors are RELATIVE to item_selector
  - Use most specific selector available
  - Handle multiple price formats (sale vs original)
  - Match item count to expected products
  - Prefer data attributes for structured data

  **Selector Best Practices:**

  **Prefer (Stable):**
  - Data attributes: [data-sku], [data-product-id]
  - Semantic roles: [role="listitem"]
  - Unique IDs: #product-grid
  - Structural: article, li.product

  **Avoid (Brittle):**
  - Hash classes: .css-1abc2de
  - Deep nesting: div > div > div.product
  - Position-based: :nth-child(2)
  - Overly generic: div, span

  **Confidence Scoring:**
  - 0.9+: Data attributes, stable patterns
  - 0.7-0.9: Reasonable class patterns
  - 0.5-0.7: Uncertain, may need fallback
  - < 0.5: Low confidence, recommend vision fallback

  Input: site_intent + page_url + page_context + repeated_elements + sample_html
  Output: extraction_schema.json with selectors and field mappings

# Integration
integration:
  invoked_by:
    - site_calibrator.calibrate
    - product_perception.pipeline._ensure_schema
  invocation_point: before_extraction_when_no_valid_schema
  output_consumers:
    - site_schema_registry  # Persists the schema
    - product_extractor     # Uses schema for extraction
    - smart_waiter          # Uses wait_selector
