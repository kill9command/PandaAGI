# Cache Decision Recipe
# Determines if a response is cacheable and sets appropriate TTL
#
# Called after synthesis, before saving. Informs both response cache
# and claims registry caching policies.

name: memory_cache_decision
category: memory
role: cache_decision
model_layer: REFLEX  # Classification tasks use REFLEX (temp 0.3)

# Prompt fragments (loaded in order)
prompt_fragments:
  - "apps/prompts/memory/cache_decision.md"

# Input documents
input_docs:
  - path: "query"
    path_type: "runtime"
    optional: false
    max_tokens: 150
    description: "User's original query"

  - path: "intent"
    path_type: "runtime"
    optional: false
    max_tokens: 50
    description: "Classified intent (transactional, informational, etc.)"

  - path: "domain"
    path_type: "runtime"
    optional: true
    max_tokens: 50
    description: "Domain category (electronics, pets, etc.)"

  - path: "response_summary"
    path_type: "runtime"
    optional: false
    max_tokens: 300
    description: "Brief summary of the response content"

  - path: "metadata"
    path_type: "runtime"
    optional: true
    max_tokens: 100
    description: "Flags: has_prices, has_availability, etc."

# Output document
output_doc:
  path: "cache_decision.json"
  path_type: "temp"

# Token budget
token_budget:
  total: 1500
  prompt: 600       # cache_decision.md prompt (includes examples)
  input_docs: 650   # query + intent + domain + summary + metadata
  output: 200       # JSON decision output
  buffer: 50

# Trimming strategy
trimming_strategy:
  method: truncate_end
  priority:
    - keep: query           # Always keep query
    - keep: intent          # Always keep intent
    - truncate: response_summary  # Truncate if needed

# Output schema
output_schema:
  type: object
  required:
    - cache_decision
    - ttl_category
    - confidence
  properties:
    cache_decision:
      type: string
      enum: ["cache", "no_cache"]
    ttl_hours:
      type: integer
      minimum: 0
      maximum: 720
      description: "Time-to-live in hours (null for no_cache)"
    ttl_category:
      type: string
      enum: ["none", "short", "medium", "long"]
    cache_key_hints:
      type: array
      items:
        type: string
      description: "Attributes to include in cache key"
    reasoning:
      type: string
      description: "1 sentence explanation"
    confidence:
      type: number
      minimum: 0
      maximum: 1

# Quality gates
quality_gates:
  schema_validation: true
  confidence_threshold: 0.7
  max_retries: 1

# Description
description: |
  Cache Decision determines cacheability and TTL for responses.

  **NOT CACHEABLE (no_cache):**
  - Time-sensitive: "current price", "in stock now"
  - Real-time data: weather, stock prices, live scores
  - Personalized: references user-specific history
  - Stale-sensitive: prices, availability, inventory

  **SHORT TTL (1-4 hours):**
  - Recent events: "latest news about"
  - Trending topics: "best X right now"
  - Fast-changing markets: crypto, flash sales

  **MEDIUM TTL (24-72 hours):**
  - Product research: specs, reviews, comparisons
  - How-to content: guides, tutorials
  - General recommendations

  **LONG TTL (168-720 hours):**
  - Factual knowledge: specs, historical data
  - Stable comparisons: "X vs Y" for established products
  - Reference material: documentation

  **Cache Key Hints:**
  - intent: always include
  - domain: for domain-specific results
  - price_range: if budget specified
  - location: if location-specific

  Input: query + intent + domain + response_summary + metadata
  Output: cache_decision.json with TTL and cache key hints
