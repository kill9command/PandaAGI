# Phase 1: Query Analyzer Recipe
# Reference resolution, user_purpose extraction, data requirements
# Architecture: architecture/main-system-patterns/phase1-query-analyzer.md

name: phase0_query_analyzer
category: pipeline
phase: 0
role: REFLEX
temperature: 0.4

prompt_fragments:
  - "apps/prompts/pipeline/phase0_query_analyzer.md"

input_docs:
  - path: "user_query"
    sections: ["raw_query"]
    path_type: "input"
    optional: false
    max_tokens: 100
    description: "Raw user input"
  - path: "turn_summaries"
    sections: ["summaries"]
    path_type: "input"
    optional: true
    max_tokens: 450
    description: "Summaries from turns N-1, N-2, N-3 for reference resolution"

output_doc:
  path: "context.md"
  section: "0"
  description: "Writes section 0 with resolved query, user_purpose, data_requirements, reference_resolution, validation"

token_budget:
  total: 1500
  prompt: 600
  input_docs: 550
  output: 200
  buffer: 150

llm_params:
  temperature: 0.4
  max_tokens: 200

output_schema: QUERY_ANALYSIS

description: |
  Phase 1: Query Analyzer

  Runs before context retrieval (Phase 2.1). Uses REFLEX role (temp=0.4) for fast,
  deterministic extraction.

  **Responsibilities:**
  - Resolve pronoun and reference expressions to explicit entities
  - Capture user purpose in natural language (2-4 sentences)
  - Identify data requirements (prices, live data, freshness)
  - Identify references to prior conversation content

  **Output:**
  ```json
  {
    "resolved_query": "string",
    "user_purpose": "Natural language statement (2-4 sentences)",
    "data_requirements": {"needs_current_prices": bool, ...},
    "reference_resolution": {"status": "not_needed|resolved|failed", ...},
    "mode": "chat|code",
    "content_reference": {...},
    "reasoning": "string"
  }
  ```
