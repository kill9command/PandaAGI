# Phase 8: Turn Summary Recipe
# Generates turn summary for indexing (runs after Save)
# Architecture: architecture/main-system-patterns/phase8-save.md

name: phase7_summarizer
category: pipeline
phase: 8
role: MIND
mode: null  # Unified for both chat and code
temperature: 0.3

prompt_fragments:
  - "apps/prompts/pipeline/phase7_summarizer.md"

input_docs:
  - path: "context.md"
    sections: ["0", "1", "2", "3", "4", "6", "7"]
    path_type: "turn"
    optional: false
    max_tokens: 3000
    description: "Full completed context.md (sections 0-4, 6-7)"

output_doc:
  path: "turn_index"
  section: "summary"
  description: "Turn summary written to turn index database"

token_budget:
  total: 4000
  prompt: 800
  input_docs: 3000
  output: 150
  buffer: 50

llm_params:
  temperature: 0.3
  max_tokens: 200

output_schema: TURN_SUMMARY

description: |
  Phase 8: Turn Summary - Turn Index Generation

  Uses MIND role (temp=0.3) for deterministic summarization.
  Runs AFTER response is sent to user (background task).
  Not part of the response path - purely for indexing.

  **Core Question:** "How do we summarize this turn for future retrieval?"

  **Responsibilities:**
  - Generate concise 1-2 sentence summary of what happened
  - Extract 2-5 topic keywords
  - Identify if research was conducted
  - Tag with research topic if applicable

  **Output (TURN_SUMMARY):**
  ```json
  {
    "summary": "<1-2 sentence summary>",
    "topics": ["<topic_1>", "<topic_2>"],
    "has_research": true,
    "research_topic": "<category.subcategory>" or null
  }
  ```

  **Usage by Phase 1:**
  The turn summary is stored in turn_index.db and appended to context.md
  as the final section for fast continuity checks.

  **Summary Guidelines:**
  - Focus on WHAT happened, not HOW
  - Keep under 2 sentences
  - Use abstract topic labels, not brand names

  **Note:** This phase does NOT affect the response to the user.
  It runs asynchronously after the turn is saved.
