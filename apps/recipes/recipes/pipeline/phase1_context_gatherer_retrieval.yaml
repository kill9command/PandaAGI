# Phase 2.1: Context Gathering â€” Retrieval (Memory Graph)
# Aligns with architecture/main-system-patterns/phase2.1-context-gathering-retrieval.md

name: phase1_context_gatherer_retrieval
category: pipeline
phase: 2
role: MIND
temperature: 0.6

token_budget:
  total: 5500
  prompt: 900      # System prompt + instructions
  input_docs: 3600 # Unified memory index + query analysis
  output: 700      # RetrievalPlan JSON
  buffer: 300

input_docs:
  - path: "query_analysis"
    path_type: "input"
    max_tokens: 600
    description: "Phase 1 narrative (resolved_query, user_purpose, reasoning) + hints"
  - path: "unified_memory_index"
    path_type: "input"
    max_tokens: 3000
    description: "Memory graph nodes across turns, preferences, facts, cache, visit records"

output_doc:
  path: "retrieval_plan.json"
  path_type: "turn"
  description: "RetrievalPlan JSON with selected nodes and coverage"

output_schema: RETRIEVAL_PLAN

system_prompt: |
  You are the Context Gatherer (RETRIEVAL phase).

  Your task is to select relevant memory nodes from a Unified Memory Index.
  Do NOT load full documents. Do NOT fabricate node_ids.

  ## Inputs
  - QueryAnalysis (narrative + hints)
  - Unified Memory Index (Obsidian-style memory graph)

  ## Output Schema (RetrievalPlan)
  {
    "selected_nodes": {
      "turn_summary": ["node_id", "..."],
      "preference": ["node_id", "..."],
      "fact": ["node_id", "..."],
      "research_cache": ["node_id", "..."],
      "visit_record": ["node_id", "..."]
    },
    "selection_reasons": {
      "turn_summary": "string",
      "preference": "string",
      "fact": "string",
      "research_cache": "string",
      "visit_record": "string"
    },
    "coverage": {
      "has_prior_turns": true | false,
      "has_memory": true | false,
      "has_cached_research": true | false,
      "has_visit_data": true | false
    },
    "reasoning": "short narrative rationale"
  }

  ## Rules
  - Use ONLY node_ids from the Unified Memory Index.
  - All keys must exist (use empty arrays if none).
  - Prefer narrative signal from `user_purpose` + `resolved_query`.
  - If hints are missing, still select relevant nodes.
  - Coverage must match selected_nodes.
