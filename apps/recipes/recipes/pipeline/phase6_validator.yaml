# Phase 7: Validation Recipe
# Quality gate: Verify response accuracy before delivery
# Architecture: architecture/main-system-patterns/phase7-validation.md

name: phase6_validator
category: pipeline
phase: 7
role: MIND
mode: null  # Unified for both chat and code
temperature: 0.6

prompt_fragments:
  - "apps/prompts/pipeline/phase6_validator.md"

input_docs:
  - path: "context.md"
    sections: ["0", "1", "2", "3", "4", "5", "6"]
    path_type: "turn"
    optional: false
    max_tokens: 4000
    description: "Full context: query, validation, context, plan, execution, synthesis"
  # Note: response is in context.md ยง6, not a separate file
  # Keeping this optional for backwards compatibility
  - path: "response.md"
    sections: ["all"]
    path_type: "turn"
    optional: true
    max_tokens: 1500
    description: "Draft response to validate (optional, response is in ยง6)"

output_doc:
  path: "context.md"
  section: "7"
  description: "Writes section 7 with validation result"

token_budget:
  total: 6000
  prompt: 1500
  input_docs: 4000
  output: 300
  buffer: 200

llm_params:
  temperature: 0.6
  max_tokens: 500

output_schema: VALIDATION_RESULT

description: |
  Phase 7: Validation - Quality Gate

  Uses MIND role (temp=0.6) for accurate assessment.
  Final checkpoint before delivering response to user.

  **Core Question:** "Is this response accurate and complete?"

  **Five Mandatory Checks:**
  1. Claims Supported - Every claim has evidence in section 4 or 2
  2. No Hallucinations - No invented information
  3. Query Addressed - Response answers section 0 question
  4. Coherent Format - Well-structured and readable
  5. Source Metadata Present - Claims include url or source_ref

  **Decision Table:**
  | Decision | Confidence | Action |
  |----------|------------|--------|
  | APPROVE | >= 0.80 | Send to user, Phase 8 (Save) |
  | REVISE | 0.50-0.79 | Loop to Phase 6 with hints |
  | RETRY | 0.30-0.49 | Loop to Phase 3 with fixes |
  | FAIL | < 0.30 | Send error message |

  **Output (VALIDATION_RESULT):**
  ```json
  {
    "decision": "APPROVE|REVISE|RETRY|FAIL",
    "confidence": 0.0-1.0,
    "issues": ["list of problems found"],
    "checks": {
      "claims_supported": true|false,
      "no_hallucinations": true|false,
      "query_addressed": true|false,
      "coherent_format": true|false,
      "source_metadata_present": true|false
    },
    "revision_hints": "Guidance for Synthesis if REVISE",
    "suggested_fixes": "Guidance for Planner if RETRY"
  }
  ```

  **Multi-Goal Validation:**
  When query has multiple goals, validate each independently:
  - All goals PASS -> APPROVE
  - Any goal FAIL, others PASS -> REVISE
  - Multiple goals FAIL -> RETRY
