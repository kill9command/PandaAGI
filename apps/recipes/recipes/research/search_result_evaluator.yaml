# Search Result Evaluator Recipe
# Evaluates search result quality to determine if more searches needed
#
# Used by search_result_evaluator.py for adaptive search refinement.

name: research_search_result_evaluator
category: research
role: search_result_evaluator
model_layer: REFLEX  # Classification task uses REFLEX (temp 0.2)

# Prompt fragments (loaded in order)
prompt_fragments:
  - "apps/prompts/research/search_result_evaluator.md"

# Input documents
input_docs:
  - path: "goal"
    path_type: "runtime"
    optional: true
    max_tokens: 200
    description: "Research goal to evaluate against"

  - path: "required_fields"
    path_type: "runtime"
    optional: true
    max_tokens: 100
    description: "Fields that must be present for satisfaction"

  - path: "results_summary"
    path_type: "temp"
    optional: false
    max_tokens: 1500
    description: "Summary of search results to evaluate"

# Output document
output_doc:
  path: "search_evaluation.json"
  path_type: "temp"

# Token budget
token_budget:
  total: 2500
  prompt: 600       # search_result_evaluator.md prompt
  input_docs: 1600  # results summary is bulk
  output: 300       # JSON evaluation
  buffer: 0

# Trimming strategy
trimming_strategy:
  method: intelligent_truncate
  priority:
    - keep: goal
    - keep: required_fields
    - truncate: results_summary

# Output schema
output_schema:
  type: object
  required:
    - satisfied
    - quality_score
    - recommendation
  properties:
    satisfied:
      type: boolean
    quality_score:
      type: number
      minimum: 0
      maximum: 1
    gaps:
      type: string
    recommendation:
      type: string
      enum: ["continue", "stop"]
    suggested_refinements:
      type: array
      items:
        type: string

# Quality gates
quality_gates:
  schema_validation: true
  max_retries: 2

# Description
description: |
  Search Result Evaluator assesses search result quality and determines
  whether additional queries are needed.

  **Quality Factors:**
  - Result count (0 = retry, 5+ = good)
  - Required field coverage (price, availability, etc.)
  - Source diversity (multiple retailers)
  - Relevance to goal

  **Decisions:**
  - quality_score >= 0.7: STOP (satisfied)
  - quality_score < 0.7: CONTINUE (suggest refinements)

  Input: goal + required_fields + results_summary
  Output: search_evaluation.json with satisfaction and refinements

# Integration
integration:
  invoked_by:
    - search_result_evaluator.SearchResultEvaluator._llm_evaluation
  invocation_point: during_adaptive_search
